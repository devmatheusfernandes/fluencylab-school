# Plano de Implementação: Módulo Financeiro e Fiscal

Este plano detalha a implementação do novo módulo financeiro seguindo estritamente as especificações do arquivo `feature.md`.

## 1. Modelagem de Dados (Types)

Criar as definições de tipos para garantir a tipagem estrita em todo o fluxo financeiro.

* **Arquivo:** `types/financial/financial.ts`

* **Conteúdo:**

  * Enums/Types: `CompanyType`, `FiscalStatus`, `PaymentStatus`, `TeacherType`.

  * Interfaces: `CompanyConfig`, `FiscalYear`, `MonthlyRevenue` (Snapshot), `TeacherPaymentRecord`.

## 2. Server Actions (Lógica de Negócio)

Implementar as ações do servidor que manipularão o banco de dados com segurança e transações.

* **Arquivo:** `actions/financial.ts`

* **Ação:** **`closeMonthAction(year, month)`**

  * Verificar se o mês já foi fechado.

  * Buscar pagamentos de alunos (`PAID` no período).

  * Buscar aulas concluídas pelos professores no período (Regime de Competência).

  * Calcular totais (Receita Bruta, Custos de Professores).

  * Aplicar regras fiscais (MEI vs ME, limites, INSS para PF).

  * Executar `runTransaction` (Firebase Admin) para:

    * Salvar `MonthlyRevenue` (Snapshot imutável).

    * Atualizar/Criar `FiscalYear` acumulado.

    * Gerar registros de `TeacherPaymentRecord` (Obrigações a pagar).

* **Ação:** **`markTeacherPaymentAsPaid(recordId)`**

  * Validar status atual.

  * Atualizar status para `PAID` e setar `paidAt`.

  * (Opcional) Verificar anexo de Nota Fiscal para PJ.

## 3. Hooks Customizados (Frontend Logic)

Criar hooks para abstrair a lógica de busca e atualização de dados no client-side.

* **Arquivos:** `hooks/financial/`

  * `useFiscalYear.ts`: Listener em tempo real da coleção `fiscal_years`. Retorna status do limite MEI/ME.

  * `useMonthlyClose.ts`: Wrapper para a server action de fechamento, com estados de loading/error.

  * `useTeacherPayments.ts`: Busca e filtra os registros de pagamento de professores.

## 4. UI - Dashboard Fiscal

Desenvolver a interface administrativa utilizando **shadcn/ui**.

* **Página:** `app/[locale]/hub/admin/finance/fiscal/page.tsx`

* **Componentes:**

  * **Header:** Título e controles de período (Mês/Ano).

  * **FiscalSummary:** Cards com Faturamento Anual, Status Fiscal (MEI/ME) e Barra de Progresso do Limite.

  * **ActionPanel:** Botão "Fechar Mês" (habilitado apenas para meses passados e abertos).

  * **TeacherPaymentsTable:** Tabela listando obrigações com professores:

    * Colunas: Professor, Competência, Bruto, Descontos (INSS), Líquido, Status.

    * Ações: "Marcar como Pago", "Baixar RPA" (placeholder), "Anexar NF".

## 5. Configuração Inicial

* Criar um script ou função para inicializar a `CompanyConfig` no Firestore com os valores padrão (MEI, limites, alíquotas).

## Ordem de Execução

1. **Types**: Criar `types/financial/financial.ts`.
2. **Actions**: Implementar `actions/financial.ts` (começando pelo esqueleto e depois a lógica complexa).
3. **Hooks**: Criar os hooks básicos.
4. **UI**: Construir a página e conectar com os hooks.
5. **Validação**: Testar o fluxo de fechamento de mês e verificar os cálculos (Snapshots e Obrigações).

