# Planejamento: Implementação de Agendamento por Créditos

Este plano detalha a implementação do fluxo de agendamento de aulas utilizando créditos de "Bônus" e "Aluno Tardio", abrangendo Backend (Service/API) e Frontend (Hooks/UI).

## 1. Backend: Lógica e API

### 1.1. Atualizar `SchedulingService`
- **Arquivo:** `services/learning/schedulingService.ts`
- **Ação:** Adicionar método `bookClassWithCredit`.
- **Responsabilidades:**
  - Validar regras de antecedência (lead time) e horizonte de agendamento.
  - Executar transação no Firestore:
    - Verificar disponibilidade do slot (bloqueio otimista).
    - Verificar existência do crédito (Bônus ou Tardio).
    - Criar o documento da aula (`classType: 'regular'`, `creditType` preenchido).
    - Criar exceção na agenda do professor (`AvailabilityException`).
  - Consumir o crédito após sucesso da transação.
  - Enviar notificações (Email + System Announcement).

### 1.2. Criar Rota de API
- **Arquivo:** `app/api/student/classes/book-with-credit/route.ts` (Novo)
- **Ação:** Criar endpoint `POST`.
- **Responsabilidades:**
  - Validar sessão do usuário (apenas `role: student`).
  - Receber: `teacherId`, `scheduledAt`, `availabilitySlotId`, `creditType`, `classTopic`.
  - Chamar `schedulingService.bookClassWithCredit`.
  - Tratar erros e retornar status adequado.

## 2. Frontend: Hooks e Lógica

### 2.1. Novo Hook de Disponibilidade
- **Arquivo:** `hooks/student/useTeacherAvailabilityForBooking.ts` (Novo)
- **Ação:** Criar hook customizado.
- **Responsabilidades:**
  - Buscar disponibilidade do professor via `/api/student/availability`.
  - Filtrar slots disponíveis baseados em regras de negócio (Lead time, conflitos, exceções).
  - Expandir horários recorrentes para datas concretas.
  - Retornar lista limpa de `AvailableTimeSlot` para a UI.

### 2.2. Atualizar `useStudent`
- **Arquivo:** `hooks/student/useStudent.ts`
- **Ação:** Adicionar função `bookClassWithCredit`.
- **Responsabilidades:**
  - Realizar a chamada `POST` para a nova rota de API.
  - Gerenciar estados de `loading` e `error`.
  - Atualizar a lista de aulas (`fetchMyClasses`) após sucesso.

## 3. Frontend: Interface (UI)

### 3.1. Criar Componente `CreditBookingModal`
- **Arquivo:** `components/student/CreditBookingModal.tsx` (Novo)
- **Ação:** Criar componente de modal isolado.
- **Features:**
  - **Seleção de Professor:** Dropdown populado a partir dos professores das aulas atuais do aluno (extraído de `myClasses`).
  - **Calendário/Lista de Slots:** Exibir horários disponíveis usando `useTeacherAvailabilityForBooking`.
  - **Confirmação:** Resumo da ação (gasto de 1 crédito) e campo para tópico da aula.
  - **Feedback:** Toast de sucesso/erro.

### 3.2. Atualizar `StudentClassesComponent`
- **Arquivo:** `components/student/StudentClassesComponent.tsx`
- **Ação:** Integrar o novo modal.
- **Alterações:**
  - Adicionar botão "Agendar Aula" no Card de Créditos Extras (condicional: só aparece se tiver crédito).
  - Gerenciar estado de abertura do `CreditBookingModal`.
  - Passar o tipo de crédito selecionado (`bonus` ou `late_student`) para o modal.

---

## Ordem de Execução
1.  **Backend:** Implementar Service e Rota API.
2.  **Hooks:** Implementar `useTeacherAvailabilityForBooking` e atualizar `useStudent`.
3.  **UI:** Criar `CreditBookingModal` e integrar em `StudentClassesComponent`.
