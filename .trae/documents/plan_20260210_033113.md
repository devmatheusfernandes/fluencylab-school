# Plan: Implement Sequential Lesson Creation Flow

We will transform the lesson creation process into a guided, linear "onboarding-style" flow with 9 distinct steps. This involves creating a new layout, a state management component, and a new analysis step using Gemini.

## 1. Data Model Updates
We need to track the progress of the creation flow and store the results of the new analysis step.
- **File**: `types/learning/lesson.ts`
  - Add `creationStep` (number, 1-9) to `Lesson` interface.
  - Add `qualityAnalysis` field to store the audit report from Step 2.

## 2. New Server Action: Lesson Analysis (Step 2)
Create a new server action to handle the "Quality Check" using Gemini and `auditoria-aula.md` rules.
- **File**: `actions/lessonAnalysis.ts` (New)
  - Function: `analyzeLessonQuality(lessonId: string)`
  - Reads `auditoria-aula.md`.
  - Uses `gemini-flash-latest` to analyze content.
  - Returns: Audit compliance (Pass/Fail per section), Suggested Level, Target/Base Language.
  - Updates `lesson.qualityAnalysis` and `lesson.creationStep`.

## 3. UI Components: Creation Flow & Stepper
Create a set of components to manage the 2-column layout and step navigation.
- **Directory**: `components/lessons/creation/`
- **File**: `LessonCreationFlow.tsx` (Client Component)
  - Main state manager.
  - Renders `LessonCreationSidebar` (Left) and current Step Component (Right).
  - Handles "Next/Mark as Done" logic.
- **File**: `LessonCreationSidebar.tsx`
  - Displays the 9 steps with status indicators (circle check, active/disabled states).
- **Directory**: `components/lessons/creation/steps/`
  - `StepAnalysis.tsx`: Displays the Gemini audit report and allows Level override.
  - `StepProcessing.tsx`: Wraps the execution of `analyzeLessonContent` and `processLessonBatch`.

## 4. Page Refactor
Replace the current tab-based page with the new flow orchestrator.
- **File**: `app/[locale]/hub/material-manager/lessons/[lessonId]/page.tsx`
  - Fetch `Lesson`, `LearningItems` (vocabulary), `LearningStructures`, and `LearningStructureIds`.
  - Pass all data to `LessonCreationFlow`.
  - Handle data refreshing (`router.refresh`) when steps complete.

## 5. Step Implementation Details
1.  **Editor**: Reuse `LessonEditor`. Add "Finish & Analyze" button.
2.  **Analysis**: Use `StepAnalysis.tsx`. Shows audit table. User confirms to proceed.
3.  **Processing**: Use `StepProcessing.tsx`. Buttons to trigger `analyzeLessonContent` (Step 3a) and `processLessonBatch` (Step 3b). Visual feedback for queues.
4.  **Review Components**: Reuse `LessonComponentsManager`. Add "Mark Reviewed" button.
5.  **Podcast**: Button to trigger `generateLessonPodcast` + `generateLessonTranscript`.
6.  **Review Transcript**: Reuse `LessonTranscriptEditor`. Add "Mark Reviewed" button.
7.  **Generate Quiz**: Button to trigger `generateLessonQuiz`.
8.  **Review Quiz**: Reuse `LessonQuizEditor`. Add "Mark Reviewed" button.
9.  **Publish**: Reuse `LessonOperations` (Approve/Publish logic).

## 6. Helper Action
- **File**: `actions/lessonUpdating.ts` (or similar)
  - Add `updateLessonStep(lessonId, step)` to manually advance steps when the user clicks "Mark as Done".

## Verification
- Verify that `creationStep` persists in Firestore.
- Verify that the layout is responsive and follows the requested design.
- Ensure existing logic in `actions/lessonProcessing.ts` remains intact.
