# Plano de Implementação: Refinamento da Lógica de Prática

Este plano detalha as alterações necessárias para corrigir os problemas de fallback e seleção de conteúdo na feature de prática diária. As mudanças são focadas em garantir que o usuário nunca receba um exercício "quebrado" ou pedagogicamente inútil.

## Arquivos Afetados

1. [`actions/srsActions.ts`](file:///c:/Users/Mathe/OneDrive/Documentos/Projetos%20de%20Programação/Em%20progresso/fluencylab-school/actions/srsActions.ts) - Responsável por **selecionar** o conteúdo.
2. [`lib/learning/practiceLogic.ts`](file:///c:/Users/Mathe/OneDrive/Documentos/Projetos%20de%20Programação/Em%20progresso/fluencylab-school/lib/learning/practiceLogic.ts) - Responsável por **formatar** o exercício (payload).

***

## Detalhes da Implementação

### 1. Filtragem de Conteúdo (Dia 1 & 4)

**Objetivo:** Impedir que frases (Structures) apareçam em dias de Flashcard, onde não funcionam bem.
**Arquivo:** `actions/srsActions.ts`

* **Lógica Atual:** Carrega `learningItems` (Vocabulário) E `learningStructures` (Frases) indiscriminadamente.

* **Nova Lógica:**

  1. Criar uma lista de permissão `structureModes` contendo apenas modos que suportam frases: `sentence_unscramble`, `gap_fill_listening`, `quiz_comprehensive`, `listening_choice`.
  2. Ao buscar itens da `activeLesson`, carregar `learningStructures` **apenas se** o modo do dia estiver nesta lista.

### 2. Fallback de Áudio no Dia 6 (Listening Choice)

**Objetivo:** Evitar tela quebrada se a lição não tiver áudio.
**Arquivo:** `actions/srsActions.ts`

* **Lógica Atual:** Se o dia for 6, tenta renderizar o player de áudio independente da existência da URL.

* **Nova Lógica:**

  1. Dentro do bloco de Quiz/Listening, verificar `if (mode === "listening_choice" && !fullLessonContext.audioUrl)`.
  2. Se verdadeiro, definir uma variável `effectiveMode = "quiz_comprehensive"`.
  3. Usar `effectiveMode` para gerar os itens do quiz e definir o modo de retorno da sessão.

### 3. Fallback de Estrutura no Dia 2 (Gap Fill)

**Objetivo:** Se uma frase não tiver áudio para "Ouvir e Preencher", mudar para "Desembaralhar" em vez de mostrar um Flashcard ruim.
**Arquivo:** `lib/learning/practiceLogic.ts`

* **Lógica Atual:** Se não achar segmento de áudio -> Fallback para `flashcard_visual`. Para Structures, isso gera o card com verso "Structure Practice".

* **Nova Lógica:**

  1. No `case "gap_fill_listening"`, dentro do bloco `else` (sem áudio):
  2. Verificar `if (!isItem)` (é uma Structure?).
  3. Se sim, alterar `base.renderMode = "sentence_unscramble"`.
  4. Gerar o payload de unscramble (ordenar palavras da sentença) ali mesmo.
  5. Se for Item (Vocabulário), manter o fallback atual para Flashcard.

***

## Verificação de Segurança (Risk Assessment)

* **Compatibilidade:** As mudanças utilizam tipos e interfaces já existentes (`PracticeMode`, `LearningStructure`), sem alterar o banco de dados.

* **Regressão:**

