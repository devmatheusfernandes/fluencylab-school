Repository Functions and Utilities

This document lists exported functions, classes, and singletons from the `repositories` directory to help reuse existing logic and avoid duplication.

Index (central utilities)
- File: `repositories/index.ts`
- Exports singletons: `userRepository`, `userAdminRepository`, `classRepository`, `classTemplateRepository`, `availabilityRepository`, `paymentRepository`, `placementRepository`, `contractRepository`, `vacationRepository`, `announcementRepository`, `achievementRepository`
- Legacy aliases: `legacyUserRepository`, `legacyClassTemplateRepository` (aliases to centralized instances)
- Types: `RepositoryInstances`
- Utilities:
  - `getAllRepositories(): RepositoryInstances` – returns all singleton instances
  - `validateRepositoryInstances(): boolean` – checks initialization of singletons

UserRepository
- File: `repositories/userRepository.ts`
- Class: `UserRepository`
  - `findById(id: string): Promise<User | null>`
  - `findByEmail(email: string): Promise<User | null>`
  - `update(userId: string, data: Partial<User>): Promise<void>`
- Singleton (in index.ts): `userRepository`

UserAdminRepository
- File: `repositories/user.admin.repository.ts`
- Utility function:
  - `getUserById_Admin(userId: string): Promise<User | null>`
- Class: `UserAdminRepository`
  - `findUsersByRole(role: string): Promise<User[]>`
  - `findUserById(userId: string): Promise<User | null>`
  - `findUsersByIds(userIds: string[]): Promise<User[]>`
  - `listUsers(filters?: { role?: string; isActive?: boolean }): Promise<User[]>`
  - `updateUserStatus(userId: string, isActive: boolean): Promise<void>`
  - `update(userId: string, data: Partial<User>): Promise<void>`
  - `countNewUsersThisMonth(): Promise<number>`
  - `countActiveTeachers(): Promise<number>`
  - `create(userData: Partial<User>): Promise<string>`

ClassRepository
- File: `repositories/classRepository.ts`
- Class: `ClassRepository`
  - `createWithTransaction(transaction: FirebaseFirestore.Transaction, classData: Omit<StudentClass, 'id'>): string`
  - `findClassesByTeacherId(teacherId: string): Promise<StudentClass[]>`
  - `findFutureClassesByTeacherId(teacherId: string): Promise<StudentClass[]>`
  - `findAllClassesByTeacherId(teacherId: string): Promise<StudentClass[]>`
  - `findClassesByStudentId(studentId: string): Promise<StudentClass[]>`
  - `findClassByTeacherAndDateWithTransaction(transaction: Transaction, teacherId: string, scheduledAt: Date): Promise<FirebaseFirestore.QuerySnapshot>`
  - `countClassesOnDateForTeacher(transaction: Transaction, teacherId: string, date: Date): Promise<number>`
  - `findClassById(classId: string): Promise<StudentClass | null>`
  - `countClassesForToday(): Promise<number>`
  - `findRecentClassesWithUserDetails(limit: number): Promise<PopulatedStudentClass[]>`
  - `batchCreate(classes: Omit<StudentClass, 'id'>[]): Promise<void>`
  - `updateClassesStatusInRange(transaction: Transaction, teacherId: string, startDate: Date, endDate: Date, newStatus: ClassStatus): Promise<void>`
  - `findClassesByTeacherInRange(teacherId: string, startDate: Date, endDate: Date): Promise<StudentClass[]>`
  - `findAllClassesByStudentId(studentId: string): Promise<StudentClass[]>`
  - `deleteFutureClassesByTemplate(studentId: string, templatesToRemove: ClassTemplateDay[]): Promise<void>`
  - `deleteFutureClassesFromDate(studentId: string, fromDate: Date): Promise<number>`
  - `deleteFutureClassesInRange(studentId: string, fromDate: Date, toDate: Date): Promise<number>`
  - `deleteFutureClassesByTemplateFromDate(studentId: string, templateEntries: ClassTemplateDay[], fromDate: Date): Promise<number>`
  - `deleteFutureClassesByTemplateInRange(studentId: string, templateEntries: ClassTemplateDay[], fromDate: Date, toDate: Date): Promise<number>`
  - `hasFutureScheduledClasses(studentId: string): Promise<boolean>`
  - `updateClassesBySchedule(studentId: string, day: string, hour: string, newTeacherId: string): Promise<void>`
  - `update(classId: string, data: Partial<StudentClass>): Promise<void>`

ClassTemplateRepository
- File: `repositories/ClassTemplateRepository.ts`
- Class: `ClassTemplateRepository`
  - `get(studentId: string): Promise<ClassTemplate | null>`
  - `upsert(studentId: string, templateData: ClassTemplate): Promise<void>`
  - `delete(studentId: string): Promise<void>`
- Singleton (in index.ts): `classTemplateRepository`

AvailabilityRepository
- File: `repositories/availabilityRepository.ts`
- Class: `AvailabilityRepository`
  - `create(slotData: Omit<AvailabilitySlot, 'id'>): Promise<AvailabilitySlot>`
  - `findById(slotId: string): Promise<AvailabilitySlot | null>`
  - `findByTeacherId(teacherId: string): Promise<AvailabilitySlot[]>`
  - `deleteById(slotId: string): Promise<void>`
  - `update(slotId: string, data: object): Promise<void>`
  - `createException(slotId: string, teacherId: string, exceptionDate: Date): Promise<void>`
  - `findExceptionsByTeacherId(teacherId: string): Promise<AvailabilityException[]>`
  - `createExceptionWithTransaction(transaction: Transaction, slotId: string, teacherId: string, exceptionDate: Date): void`
  - `findAndDeleteException(originalSlotId: string, exceptionDate: Date): Promise<void>`

PaymentRepository
- File: `repositories/paymentRepository.ts`
- Class: `PaymentRepository`
  - `findByUserId(userId: string): Promise<Payment[]>`

PlacementRepository
- File: `repositories/placementRepository.ts`
- Class: `PlacementRepository`
  - `getPlacementTestsByUserId(userId: string): Promise<PlacementTest[]>`
  - `subscribeToPlacementTests(userId: string, callback: (tests: PlacementTest[]) => void): () => void`
- Singleton (in index.ts): `placementRepository`

VacationRepository
- File: `repositories/VacationRepository.ts`
- Class: `VacationRepository`
  - `create(vacationData: Omit<Vacation, 'id'>): Promise<Vacation>`
  - `createWithTransaction(transaction: Transaction, vacationData: Omit<Vacation, 'id'>): void`
  - `findByTeacherAndYear(teacherId: string, year: number): Promise<Vacation[]>`
  - `findAllByTeacherId(teacherId: string): Promise<Vacation[]>`
  - `delete(vacationId: string): Promise<void>`
- Singleton (in index.ts): `vacationRepository`

AnnouncementRepository
- File: `repositories/announcementRepository.ts`
- Class: `AnnouncementRepository`
  - `create(announcement: Omit<Announcement, 'id' | 'createdAt' | 'readBy'>): Promise<Announcement>`
  - `findAll(): Promise<Announcement[]>`
  - `findById(id: string): Promise<Announcement | null>`
  - `update(id: string, data: Partial<Announcement>): Promise<void>`
  - `delete(id: string): Promise<void>`
  - `markAsRead(announcementId: string, userId: string): Promise<void>`
  - `getAnnouncementsForUser(userId: string, userRole: UserRoles): Promise<Announcement[]>`
  - `getUnreadCountForUser(userId: string, userRole: UserRoles): Promise<number>`

AchievementRepository
- File: `repositories/achievementRepository.ts`
- Class: `AchievementRepository`
  - `getStudentAchievements(studentId: string): Promise<StudentAchievement[]>`
  - `updateStudentAchievements(studentId: string, achievements: StudentAchievement[]): Promise<void>`
  - `addStudentAchievement(studentId: string, achievement: StudentAchievement): Promise<void>`

ContractRepository
- File: `repositories/contractRepository.ts`
- Class: `ContractRepository`
  - `getContractStatus(userId: string): Promise<ContractStatus | null>`
  - `getContractLog(userId: string, logId: string): Promise<ContractLog | null>`
  - `createContractLog(userId: string, contractData: Omit<ContractLog, 'logID'>): Promise<string>`
  - `updateContractStatus(userId: string, status: ContractStatus): Promise<void>`
  - `signContractAsAdmin(userId: string, logId: string, adminData: { name: string; cpf: string; ip?: string; browser?: string; }): Promise<void>`
  - `invalidateContract(userId: string): Promise<void>`
  - `getUserContractLogs(userId: string, limitCount?: number): Promise<ContractLog[]>`
  - `getUsersWithPendingContracts(): Promise<{ userId: string; status: ContractStatus }[]>`
  - `validateContractData(contractData: Partial<ContractLog>): ContractValidationError[]`
  - `updateContractForRenewal(userId: string, renewalData: { newExpirationDate: string; renewalCount: number; lastRenewalAt: string; autoRenewal: boolean; }): Promise<void>`
  - `updateContractForCancellation(userId: string, cancellationData: { cancelledAt: string; cancelledBy: string; cancellationReason: string; }): Promise<void>`
  - `getAllUsersWithActiveContracts(): Promise<{ userId: string; status: ContractStatus }[]>`
  - `createRenewalLog(userId: string, renewalData: { previousExpirationDate: string; newExpirationDate: string; renewalCount: number; renewalType: 'automatic' | 'manual'; renewedBy?: string; }): Promise<string>`
  - `createCancellationLog(userId: string, cancellationData: { cancelledBy: string; cancellationReason: string; isAdminCancellation: boolean; }): Promise<string>`
  - `getUserRenewalHistory(userId: string): Promise<any[]>`
  - `getUserCancellationHistory(userId: string): Promise<any[]>`
- Singleton (in index.ts): `contractRepository`

Usage Tips
- Prefer importing singletons from `repositories/index.ts` to avoid duplicate instances.
- When performing batched or transactional writes, use repository methods that accept `Transaction` to maintain consistency.
- For client-side realtime subscriptions, rely on methods that explicitly use client SDKs (e.g., `PlacementRepository.subscribeToPlacementTests`).